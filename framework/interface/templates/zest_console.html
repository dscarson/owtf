{% extends base.html %}

{% block title %}Zest Console{% end %}


{% block includes %}

<style type="text/css">

body,html,.row-offcanvas {
  height:100%;
}

body {
  padding-top: 50px;
}

#sidebar {
  width: inherit;
  min-width: 220px;
  max-width: 220px;
  background-color:#f5f5f5;
  float: left;
  height:100%;
  position:relative;
  overflow-y:auto;
  overflow-x:hidden;
}

#main {
  height:100%;
  overflow:auto;
}

.btn{
  margin:30px;
  padding:7px;

}

.btn:focus,a, a:active, a:focus{
  outline: none;
}

  /* 1st level */
.nav label {
  color: blue;
}

/* 2nd level */
.tree > li > label {
  padding:10px 15px;  
}

/* 3rd level */
.tree > li > ul > li > a {
  color:#cc0000;
  font-size:10pt;
  margin-left:15px;
}

.modal-dialog-center{
  width: 320px;
  margin: 0;
  position: absolute;
  top: 35%;
  left: 42%;
}

</style>

{% end %}

{% block content %}

<div class="container">
  <div class="row">
      <div class="col-md-3">
          <div class="well">
              <div>
                  <ul id="allscripts" class="nav nav-stacked fixed">
                      <li>
                          <label label-default="" class="tree-toggle nav-header">Other Recorded Scripts</label>
                          <ul id="rec_scripts" class="nav tree">
                          </ul>
                      </li>
                      <li>
                        <label label-default="" class="tree-toggle nav-header">Zest Scripts in Scope</label>
                        <ul id="tar_scripts" class="nav tree">
                        </ul>
                      </li>
                
                  </ul>
              </div>
          </div>
      </div>
      <div class="col-md-9">
        <div id="script_detail">
         <div id="script_data">
        <h4>Script Content</h4>
      <pre id="script_content"></pre>
        </div>
       <div id="script_result">
        <h4>Zest Output</h4>
      <pre id="script_output"></pre>
       </div>
     </div>
          <div class="row pull-right" style="text-align:center" >

  <button class="btn btn-primary" onclick="RecordToggle()"
    id="recordZest">Record a Zest Script!</button>
  <button class="btn btn-primary" id="ForwardZest">Forward to ZAP !</button>
  <button class="btn btn-primary" id="RunZest" onclick="RunZestScript()"> Run the Zest Script !
  </button>
</div>

    </div>
  </div>
</div>

<!--Script Name Modal-->
<div class="modal fade" id="ScriptModal" tabindex="-1" role="dialog"
     aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog-center">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button"  class="close"  data-dismiss="modal" aria-hidden="true">&times;</button>
        <h4 class="modal-title" id="myModalLabel">Enter Script Name :</h4>
        <h6 class="modal-title" id="name_tip">(only alphanumeric characters)</h6>
      </div>
      <div class="modal-body">
        <p id="Filecheck" style="color:red"></p>
        <input type="text" id="textareaID" class="form-control"></input>
      </div>
      <div class="modal-footer">
         <button type="button" class="btn-primary" id="startBtn" onclick="StartRecording()">Start!</button>
        <button type="button" class="btn-default"  data-dismiss="modal">Cancel</button>
       
      </div>
    </div>
  </div>
</div>





<script>

var mySpace = {

                    zest_console_api_url:"{{ zest_console_api_url }}",
                    zest_recording:"{{ zest_recording }}",
                    zest_target_heading:"{{ zest_target_heading }}",
              };


function RunZestScript(){
    $("#script_content").css("height","250px");
    $("#script_result").show();
    $("#script_output").text('');
    $("#script_result").css("height","250px");
    var script = $('li .active')
    RunScript(script);
}

function RunScript(script){
   var id = script.parent().attr('id');
   if (id=="tar_scripts"){
    $.getJSON(mySpace.zest_console_api_url+"?record=false&run=true&script="+script.attr('name'),function(obj){
          SetContentResultWindow(obj.result);
    });

   }
   else{
    $.getJSON(mySpace.zest_console_api_url+"?record=true&run=true&script="+script.text(),function(obj){
          SetContentResultWindow(obj.result);
    });

   }
    $("#script_output").css("height","220px");
}

function SetContentResultWindow(content){
    $("#script_output").text(content);

}
//get scripts in zest output folder of the target
function GetScriptNames(){
    $.getJSON(mySpace.zest_console_api_url,function(obj){
    var target_list=obj.files;
    var rec_list=obj.recorded_files;
    LoadTargetScriptNames(target_list);
    LoadRecordScriptNames(rec_list);
    });
}

function GetTargetSpecificName(name){
  return mySpace.zest_target_heading+"-"+name;

}
function LoadTargetScriptNames(target_list){
    $("#tar_scripts").empty();
    for (i=0;i<target_list.length;i++){
      if (i==0){
        $("#tar_scripts").append('<li class="active" name='+target_list[i]+'><a href="#">'+
          GetTargetSpecificName(target_list[i])+'</a></li>');
        GetTargetScriptContent(target_list[i]);
      }
      else{
            $("#tar_scripts").append('<li name='+target_list[i]+'><a href="#">'+GetTargetSpecificName(target_list[i])+'</a></li>');
      }
    }
}

function LoadRecordScriptNames(rec_list){
    $("#rec_scripts").empty();
    for(i=0;i<rec_list.length;i++){
      if (i==0){
        $("#rec_scripts").append('<li name='+rec_list[i]+'><a href="#">'+rec_list[i]+'</a></li>');
      }
      else{
          $("#rec_scripts").append('<li name='+rec_list[i]+'><a href="#">'+rec_list[i]+'</a></li>');
      }
    }
    $("#rec_scripts").hide();
}

function SetRecordButton(){
    if(mySpace.zest_recording=="True"){
      RecordOn();
    }
    else{
      RecordOff();
    }
}

function RecordOn(){
    $('#recordZest').attr('class','btn btn-danger');
    $('#recordZest').text('Stop Recording !');
}

function RecordOff(){
    $('#recordZest').attr('class','btn btn-primary');
    $('#recordZest').text('Record a Zest Script!');
}


function validate_filename(elem){

        var alphaExp = /^[0-9a-zA-Z]+$/;
        //  var alphaExp=/^[\w,\s-]+/
        if(elem.match(alphaExp)){
          // $('#ScriptModal').modal('hide');
          return true;
        }
        else{
          $("#Filecheck").text("Script name invalid !");
        }
}

// focuses/clears textbox in script modal window

$('#ScriptModal').on('show.bs.modal', function (e) {
   
        $('#textareaID').focus();
        ClearText("textareaID");
        $("#Filecheck").text('');
});

//clears text 
function ClearText(id){

        id='#'+id;
        $(id).val('');
}

function StartRecording(){
     var file_name=$('#textareaID').val();
     //validates file name using regex
     if(validate_filename(file_name)){
  
        $.ajax({
            url:mySpace.zest_console_api_url+"?record=true&file="+file_name,
            type:'GET',
            success:checkIfFileExists,
            error:function(xhr, textStatus, serverResponse){
            alert("Server replied: "+serverResponse);
                }
                
            });      
      }


}
function RecordToggle(){
    if (mySpace.zest_recording=="False"){

     $('#ScriptModal').modal('show');
    }
    else{
      $.getJSON(mySpace.zest_console_api_url+"?record=false");
      RecordOff();
      mySpace.zest_recording = "False";

    }
}

//Checks whether file exists else success 
function checkIfFileExists(data, Status, xhr){

        if(data.exists!="true"){
           $('#ScriptModal').modal('hide');
           alertSuccess("Script Created :D");
           RecordOn();
           mySpace.zest_recording = "True";

        }
        else{
           $("#Filecheck").text("Script with this name already exists !");
        }

}

//get content of the active script
function GetTargetScriptContent(script){
    $.getJSON(mySpace.zest_console_api_url+"?record=false&script="+script,function(obj){
          SetContentWindow(obj.content);
    });
}

function SetContentWindow(content){

   $("#script_content").text(content);
   $("#script_content").css("height","500px");
   $("#script_result").hide();

}
function GetRecordScriptContent(script){
    $.getJSON(mySpace.zest_console_api_url+"?record=true&script="+script,function(obj){
          SetContentWindow(obj.content);
    });
}

$('.tree-toggle').click(function (){
  $(this).parent().children('ul.tree').toggle(200);
});

//sidebar click event delegation
$('#allscripts').on('click','a', function (e) {
    $('li').removeClass('active');
    var $parent = $(this).parent();
    if (!$parent.hasClass('active')) {
      $parent.addClass('active');
      var script = $parent.attr('name');
      $p_par = $parent.parent();
      var script_t = $p_par.attr('id');
      if(script_t=="tar_scripts"){
        GetTargetScriptContent(script);
      }
      else if (script_t == "rec_scripts"){
        GetRecordScriptContent(script);
      }
    }
    e.preventDefault();
});

$(document).ready(function() {
  $('[data-toggle=offcanvas]').click(function() {
    $('.row-offcanvas').toggleClass('active');
  });
  GetScriptNames();
  SetRecordButton();
  $("#script_result").hide();
});

</script>

{% end %}