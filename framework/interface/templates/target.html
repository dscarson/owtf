{% extends base.html %}

{% block title %}Target Panel{% end %}

{% block includes %}
<!-- DataTable Requirements -->
<script type="text/javascript" charset="utf-8" src="/static/js/jquery.dataTables.min.js"></script>
<script type="text/javascript" charset="utf-8" src="/static/js/dataTables.bootstrap.js"></script>
<link href="/static/css/dataTables.bootstrap.css" rel="stylesheet">
<!-- End DataTable requirements -->

<!-- Ckeditor requirements -->
<script type="text/javascript" charset="utf-8" src="/static/js/ckeditor/ckeditor.js"></script>
<script type="text/javascript" charset="utf-8" src="/static/js/ckeditor/adapters/jquery.js"></script>
<!-- End CKeditor requirements -->
{% end %}

{% block content %}
<!-- Target INFO display, populated using JS and OWTF Sweet API -->
<div class="page-header">
    <div class="row">
        <div class="col-md-8">
            <h2 id="TargetInfo"></h2>
        </div>
        <div class="col-md-4">
            <h3 id="rankingTargetInfo"></h3>
        </div>
    </div>
</div>
<!-- End Target INFO -->

<!-- Buttons for few actions and logs -->
<div class="row">
    <div class="pull-right">
        <div class="btn-group">
            <button class="btn btn-primary" data-toggle="modal" data-target="#pluginOutputFilterModal"><i class="fa fa-filter"></i> Filter </button>
            <button class="btn btn-default" onclick="updatePluginReport();" href="#"><i class="fa fa-refresh"></i> Refresh </button>
            <button class="btn btn-danger" data-toggle="modal" data-target="#pluginLaunchModal"><i class="fa fa-flash"></i> Run Plugins </button>
            <button class="btn btn-warning" onclick="alert('Not Implemented Yet :(');"><i class="fa fa-gears"></i> Settings </button>
            <div class="btn-group">
                <button type="button" class="btn btn-info dropdown-toggle" data-toggle="dropdown">
                    Logs
                    <span class="caret"></span>
                </button>
                <ul class="dropdown-menu">
                    <li><a href="#" onclick="window.open(mySpace.transaction_log_url);"><i class="fa fa-list-alt"></i> Transaction Log </a></li>
                    <li><a href="#" onclick="window.open(mySpace.url_log_url);"><i class="fa fa-link"></i> URL Log </a></li>
                </ul>
            </div>
        </div>
    </div>
</div>
<!-- End Buttons -->

<br />

<!-- Plugin outputs loaded by JS and refreshed automatically -->
<div class="row-fluid" id="pluginReport">
    <!-- Plugin outputs grouped by test code -->
</div>
<!-- End Plugin Outputs -->

<!-- Plugin launch modal window -->
<div class="modal fade" id="pluginLaunchModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h4 class="modal-title" id="pluginLaunchModalLabel">Launch Plugins</h4>
      </div>
      <div class="modal-body" id="pluginLaunchModalBody">
        <table id="pluginLaunchTable" class="table table-hover table-striped table-bordered">
            <thead>
                <tr>
                    <th>Select</th>
                    <th>Code</th>
                    <th>Name</th>
                    <th>Type</th>
                    <th>Group</th>
                    <th>Help</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn" onclick="launchPluginsByGroup();">Run by group!</button>
        <button type="button" class="btn" onclick="launchPluginsByCode();">Run by code!</button>
        <button type="button" class="btn" onclick="launchPluginsByTypeGroup();">Run by type & Group!</button>
        <button type="button" class="btn" onclick="launchPlugins();">Run!</button>
      </div>
    </div>
  </div>
</div>
<!-- End plugin launch modal -->

<!-- Begin Plugin Output Filter Modal -->
<div class="modal fade" id="pluginOutputFilterModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h4 class="modal-title" id="pluginOutputFilterModalLabel">Advanced Filter</h4>
      </div>
      <div class="modal-body" id="pluginOutputFilterModalBody">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-success" onclick="updateFilteredPOutputApiUrl();">Apply Filter!</button>
      </div>
    </div>
  </div>
</div>
<!-- End Plugin Output Filter Modal -->

<script>
// All api urls needed for calls, these are provided by the server
var mySpace = {
                    target_api_url:"{{ target_api_url }}",
                    targets_ui_url:"{{ targets_ui_url }}",
                    poutput_ui_url:"{{ poutput_ui_url }}",
                    filtered_poutput_ui_url:"{{ poutput_ui_url }}", // This gets modified
                    plugins_api_url:"{{ plugins_api_url }}",
                    worklist_api_url:"{{ worklist_api_url }}",
                    transaction_log_url:"{{ transaction_log_url }}",
                    url_log_url:"{{ url_log_url }}",
                    target_config:{},
                  };

// Global variable for launch table is required to access the plugin selection by user
var pluginLaunchTable;

// For loading plugin report, JS fetches the html and places it at designated place
function updatePluginReport(){
    $.get( mySpace.filtered_poutput_ui_url, function(data){
            $('#pluginReport').html(data);
            });
}

// Target info loaded using API, target_api_url is helpful for that
function updateTargetInfo(){
    $.getJSON(mySpace.target_api_url, function(obj){
            mySpace.target_config = obj;
            $('#TargetInfo').html(obj.TARGET_URL+'<small> ('+obj.HOST_IP+')</small>');
            });
}

// This is called, when the plugin launcher modal is clicked. So we avoid unneccessary loading of plugin table unless user needs them 
function addPluginsToLauncher(){
    $.getJSON(mySpace.plugins_api_url, function(data){
            pluginLaunchTable.fnClearTable();
            $.each(data, function(index, obj){
                pluginLaunchTable.fnAddData([
                                            '<input type="checkbox" name="'+obj.group+'@'+obj.type+'@'+obj.code+'"/>',
                                            obj.code,
                                            (obj.name).replace(/_/g,' '),
                                            (obj.type).replace(/_/g,' '),
                                            obj.group,
                                            obj.descrip
                                            ]);
                });
            });
}

// This is called, at the start to initialize handlers to catch modal launch
function initializePluginLauncher(){
	pluginLaunchTable = $('#pluginLaunchTable').dataTable({
                "bAutoWidth":false,
	});
    $('#pluginLaunchModal').on('show.bs.modal', function(e){addPluginsToLauncher();}); // Load plugins only when modal is shown
}

// Main function that posts using API to launch plugins
function postToWorkList(pluginData){
    $.ajax({
            url:mySpace.worklist_api_url,
            type:'POST',
            data:pluginData,
            success:pluginLaunchSuccess,
            error:function(xhr, textStatus, serverResponse){
                alertFail("Server replied: "+serverResponse);
                }
            });
}

// Close the modal when plugins are launched successfully
function pluginLaunchSuccess(){
    $('#pluginLaunchModal').modal('hide');
    alertSuccess("Selected plugins launched, please check worklist to manage :D");
}

// Get the selected plugins data to post to API url
function getSelectedPlugins(){
    var sData = $('input', pluginLaunchTable.fnGetNodes()).serializeArray();
    return(sData);
}

// Get details of plugin from the coded value group@type@code
function getPluginDetails(pluginInputName){
    pluginDetails = pluginInputName.split('@');
    return({'group':pluginDetails[0], 'type':pluginDetails[1], 'code':pluginDetails[2]})
}

// To launch plugins by type and group
function launchPluginsByTypeGroup(){
    var pluginTypes = new Array();
    var pluginGroups = new Array();
    $.each(getSelectedPlugins(), function(index, obj){
        plugin = getPluginDetails(obj.name);
        if ($.inArray(plugin.type, pluginTypes) == -1) { pluginTypes.push(plugin.type);}
        if ($.inArray(plugin.group, pluginGroups) == -1) { pluginGroups.push(plugin.group);}
    });
    if (!(pluginTypes.length == 0) || !(pluginGroups.length == 0)){
        data = 'ID='+mySpace.target_config.ID+'&';
        $.each(pluginTypes, function(index, pluginType){
                data += 'type='+pluginType+'&';
                });
        $.each(pluginGroups, function(index, pluginGroup){
                data += 'group='+pluginGroup+'&';
                });
        postToWorkList(data);
    }
}

// To launch plugins by group
function launchPluginsByGroup(){
    var pluginGroups = new Array();
    $.each(getSelectedPlugins(), function(index, obj){
        plugin = getPluginDetails(obj.name);
        if ($.inArray(plugin.group, pluginGroups) == -1) { pluginGroups.push(plugin.group);}
    });
    if (!(pluginGroups.length == 0)){
        data = 'ID='+mySpace.target_config.ID+'&';
        $.each(pluginGroups, function(index, pluginGroup){
            data += 'group='+pluginGroup+'&';
        });
        postToWorkList(data);
    }
}

// To launch plugins by code
function launchPluginsByCode(){
    $.each(getSelectedPlugins(), function(index, obj){
            plugin = getPluginDetails(obj.name);
            postToWorkList('ID='+mySpace.target_config.ID+'&code='+plugin.code);
            });
}

// To launch individual plugins
function launchPlugins(){
    $.each(getSelectedPlugins(), function(index, obj){
            plugin = getPluginDetails(obj.name);
            postToWorkList('ID='+mySpace.target_config.ID+'&group='+plugin.group+'&type='+plugin.type+'&code='+plugin.code);
            });
}

// Initialize everything
$(document).ready(function() {
        updateTargetInfo()  // The target info is updated using API, kindof crazy but stable way since api is our main maintainance burden
        updatePluginReport();  // Plugin report is updated using JS
        initializePluginLauncher();  // Plugin launcher is done through a modal window
});
</script>
{% end %}
