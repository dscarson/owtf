{% extends base.html %}

{% block title %}Target Manager{% end %}

{% block includes %}
<script type="text/javascript" charset="utf-8" src="/static/js/jquery.dataTables.min.js"></script>
<script type="text/javascript" charset="utf-8" src="/static/js/dataTables.bootstrap.js"></script>
<link href="/static/css/dataTables.bootstrap.css" rel="stylesheet">
{% end %}

{% block content %}
<div class="row">
    <div class="col-md-6">
        <div class="row">
            <h3>Add Targets</h3>
            <div class="col-md-10">
                    <textarea id="newTargetUrls" type="text" class="form-control" placeholder="Targets seperated by new line">
                    </textarea>
            </div>
        </div>
        <br />
        <div class="row">
            <div class="col-md-2">
                <button class="btn btn-primary" type="button" onclick="newTargets($('#newTargetUrls').val());">Now Only God save them!</button>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <table id='targetList' class="table table-striped table-condensed">
            <thead>
                <tr>
                    <td>Target</td>
                    <td>Actions</td>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>
</div>
<script>
var mySpace = {
                    targets_api_url:"{{ targets_api_url }}",
                    targets_ui_url:"{{ targets_ui_url }}"
                  };
function addTargets(data, status, xhr){
    jQuery('#targetList').dataTable().fnClearTable();
    $.each(data, function(index, obj){
            jQuery('#targetList').dataTable().fnAddData([
                                                '<a href="'+mySpace.targets_ui_url+obj.ID+'">'+obj.TARGET_URL+' ('+obj.HOST_IP+') </a>',
                                                '<a href="#" onclick="deleteTarget('+obj.ID+');"><span class="btn btn-xs btn-danger"><i class="fa fa-times"></i></span></a>'
                                                ]);
            });
}

function updateTargets(){
    $.getJSON( mySpace.targets_api_url, addTargets);
}

function deleteTarget(target_id){
    $.ajax({
            url:mySpace.targets_api_url+target_id,
            type:'DELETE',
            success:updateTargets,
            error:function(xhr, textStatus, serverResponse){
                alertFail("Server replied: "+serverResponse);
                }
            });
}

function newTargets(targetUrlsString){
    targetUrls = targetUrlsString.split('\n');
    $.each(targetUrls, function(index, targetUrl){
            $.ajax({
                    url:mySpace.targets_api_url,
                    type:'POST',
                    data:{TARGET_URL:targetUrl},
                    success:updateTargets,
                    error:function(xhr, textStatus, serverResponse){
                        alertFail("Unable to add "+targetUrl);
                        }
                    });
            });
}

$(document).ready(function() {
        $('#targetList').dataTable({
                                            "bAutoWidth": false,
                                            "aoColumns":[null, {"bSortable":false}]
                                        });

        updateTargets();
});
</script>
{% end %}
